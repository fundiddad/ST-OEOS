# V2 è¿ç§»å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºçš„æ–°æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | è¡Œæ•° |
|------|------|------|
| `concurrent-generator-v2.js` | V2å¹¶å‘ç”Ÿæˆå™¨å®ç° | ~350è¡Œ |
| `test-concurrent-v2.js` | V2æµ‹è¯•æ–‡ä»¶ | ~120è¡Œ |
| `CONCURRENT_GENERATOR_COMPARISON.md` | V1 vs V2 å¯¹æ¯”æ–‡æ¡£ | ~260è¡Œ |
| `MIGRATION_TO_V2.md` | è¿ç§»æŒ‡å— | ~300è¡Œ |
| `V2_MIGRATION_SUMMARY.md` | æœ¬æ–‡ä»¶ | - |

### 2. ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | å½±å“ |
|------|----------|------|
| `pregeneration.js` | å¯¼å…¥ä»V1æ”¹ä¸ºV2 | é¢„ç”Ÿæˆç³»ç»Ÿç°åœ¨ä½¿ç”¨V2 |

### 3. ä¿æŒä¸å˜çš„æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ | åŸå›  |
|------|------|------|
| `concurrent-generator.js` | V1å®ç° | ä¿ç•™ç”¨äºå¯¹æ¯”å’Œå›æ»š |
| `test-concurrent-generator.js` | V1æµ‹è¯•æ–‡ä»¶ | ç”¨äºæµ‹è¯•V1åŠŸèƒ½ |
| `debug-context-comparison.js` | è°ƒè¯•å·¥å…· | ç”¨äºå¯¹æ¯”V1å’ŒSTçš„ä¸Šä¸‹æ–‡ |

---

## ğŸ¯ V2 çš„æ ¸å¿ƒæ”¹è¿›

### é—®é¢˜1ï¼šä¸ä¿å­˜åˆ°èŠå¤©è®°å½• âœ… å·²è§£å†³

**V1çš„é—®é¢˜ï¼š**
```javascript
// V1ä½¿ç”¨quietæ¨¡å¼ï¼Œä¸ä¿å­˜åˆ°èŠå¤©è®°å½•
await context.generate('quiet', { quiet_prompt: 'goto: pageId' });
// âŒ èŠå¤©ç•Œé¢çœ‹ä¸åˆ°
// âŒ èŠå¤©è®°å½•ä¸­æ²¡æœ‰
```

**V2çš„è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// V2æ‰‹åŠ¨æ·»åŠ æ¶ˆæ¯åˆ°chatæ•°ç»„
const userMessageIndex = this.addUserMessage('goto: pageId');
const aiMessageIndex = this.addAIMessage();
// âœ… èŠå¤©ç•Œé¢å¯ä»¥çœ‹åˆ°
// âœ… èŠå¤©è®°å½•ä¸­æœ‰ä¿å­˜
```

### é—®é¢˜2ï¼šè§¦å‘å‘é€æŒ‰é’®çŠ¶æ€ âœ… å·²è§£å†³

**V1çš„é—®é¢˜ï¼š**
```javascript
// V1è°ƒç”¨context.generate()ä¼šè§¦å‘UIçŠ¶æ€
await context.generate('quiet', ...);
// âš ï¸ å‘é€æŒ‰é’®å˜ä¸º"æ­£åœ¨è¯·æ±‚"çŠ¶æ€
```

**V2çš„è§£å†³æ–¹æ¡ˆï¼š**
```javascript
// V2ä½¿ç”¨dryRun=trueè·å–æ¶ˆæ¯ï¼Œä¸è§¦å‘UIçŠ¶æ€
await context.generate('normal', ..., true); // dryRun=true
// âœ… å‘é€æŒ‰é’®çŠ¶æ€ä¸å˜
```

### é—®é¢˜3ï¼šç”¨æˆ·çœ‹ä¸åˆ°ç”Ÿæˆå†…å®¹ âœ… å·²è§£å†³

**V1çš„é—®é¢˜ï¼š**
- ç”Ÿæˆçš„å†…å®¹åªå­˜åœ¨äºå†…å­˜ä¸­
- åˆ·æ–°é¡µé¢åä¸¢å¤±
- ç”¨æˆ·æ— æ³•æŸ¥çœ‹å†å²

**V2çš„è§£å†³æ–¹æ¡ˆï¼š**
- æ‰€æœ‰å†…å®¹ä¿å­˜åˆ°èŠå¤©è®°å½•
- åˆ·æ–°é¡µé¢åä»ç„¶å­˜åœ¨
- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å®Œæ•´å†å²

---

## ğŸ“Š ä¿®æ”¹å¯¹æ¯”

### pregeneration.js çš„ä¿®æ”¹

**ä¿®æ”¹å‰ï¼ˆV1ï¼‰ï¼š**
```javascript
import { getConcurrentGenerator } from './concurrent-generator.js';

async executeGeneration(slotId, pageId) {
    const generator = getConcurrentGenerator();
    const text = await generator.generatePage(slotId, pageId);
    return text;
}
```

**ä¿®æ”¹åï¼ˆV2ï¼‰ï¼š**
```javascript
import { getConcurrentGeneratorV2 } from './concurrent-generator-v2.js';

async executeGeneration(slotId, pageId) {
    const generator = getConcurrentGeneratorV2();
    // ä½¿ç”¨V2å¹¶å‘ç”Ÿæˆå™¨ï¼ˆä¿å­˜åˆ°èŠå¤©è®°å½•å¹¶æ˜¾ç¤ºåœ¨UIï¼‰
    const text = await generator.generatePage(slotId, pageId);
    return text;
}
```

**æ”¹åŠ¨é‡ï¼š**
- ä¿®æ”¹äº†2è¡Œä»£ç 
- æ·»åŠ äº†1è¡Œæ³¨é‡Š
- APIå®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹å…¶ä»–ä»£ç 

---

## ğŸš€ ä½¿ç”¨æ•ˆæœ

### ç°åœ¨çš„é¢„ç”Ÿæˆæµç¨‹

```
1. ç”¨æˆ·è¿›å…¥æ¸¸æˆï¼Œå½“å‰é¡µé¢: start
   â†“
2. é¢„ç”Ÿæˆç³»ç»Ÿæ£€æµ‹åˆ°é¡µé¢å˜æ›´
   â†“
3. å¼€å§‹é¢„ç”Ÿæˆç¬¬ä¸€å±‚é¡µé¢ï¼ˆä¾‹å¦‚ï¼šforest, village, caveï¼‰
   â†“
4. èŠå¤©ç•Œé¢æ˜¾ç¤ºï¼š
   You: goto: forest
   Assistant: [æµå¼æ˜¾ç¤ºç”Ÿæˆå†…å®¹]
   
   You: goto: village
   Assistant: [æµå¼æ˜¾ç¤ºç”Ÿæˆå†…å®¹]
   
   You: goto: cave
   Assistant: [æµå¼æ˜¾ç¤ºç”Ÿæˆå†…å®¹]
   â†“
5. æ‰€æœ‰å†…å®¹ä¿å­˜åˆ°èŠå¤©è®°å½•
   â†“
6. ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ç”Ÿæˆå†å²
```

### ç”¨æˆ·ä½“éªŒæ”¹è¿›

**V1ï¼ˆæ—§ç‰ˆæœ¬ï¼‰ï¼š**
- âŒ èŠå¤©ç•Œé¢ç©ºç™½
- âŒ ä¸çŸ¥é“ç³»ç»Ÿåœ¨åšä»€ä¹ˆ
- âŒ åˆ·æ–°é¡µé¢åå†…å®¹ä¸¢å¤±
- âš ï¸ å‘é€æŒ‰é’®å¯èƒ½é—ªçƒ

**V2ï¼ˆæ–°ç‰ˆæœ¬ï¼‰ï¼š**
- âœ… èŠå¤©ç•Œé¢æ˜¾ç¤ºæ‰€æœ‰ç”Ÿæˆå†…å®¹
- âœ… å¯ä»¥çœ‹åˆ°ç³»ç»Ÿæ­£åœ¨é¢„ç”Ÿæˆ
- âœ… åˆ·æ–°é¡µé¢åå†…å®¹ä»ç„¶å­˜åœ¨
- âœ… å‘é€æŒ‰é’®çŠ¶æ€æ­£å¸¸

---

## âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜

### 1. èŠå¤©å†å²ä¼šå¿«é€Ÿå¢é•¿

**ç°è±¡ï¼š**
- é¢„ç”Ÿæˆç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆå¤§é‡é¡µé¢
- æ¯ä¸ªé¡µé¢éƒ½ä¼šä¿å­˜åˆ°èŠå¤©è®°å½•
- èŠå¤©å†å²æ–‡ä»¶ä¼šå˜å¤§

**å»ºè®®ï¼š**

**é€‰é¡¹Aï¼šé™åˆ¶é¢„ç”Ÿæˆå±‚æ•°**
```javascript
// åœ¨ pregeneration.js çš„ triggerPregeneration æ–¹æ³•ä¸­
async triggerPregeneration(currentPageId) {
    // åªç”Ÿæˆç¬¬ä¸€å±‚
    await this.pregenerateLayer1(currentPageId);
    
    // ä¸ç”Ÿæˆç¬¬äºŒå±‚ï¼ˆæ³¨é‡Šæ‰ï¼‰
    // await this.pregenerateLayer2(currentPageId);
}
```

**é€‰é¡¹Bï¼šé™åˆ¶å¹¶å‘æ•°é‡**
```javascript
// åœ¨ pregeneration.js çš„ generatePages æ–¹æ³•ä¸­
async generatePages(parentPageId, childPageIds) {
    // é™åˆ¶æœ€å¤šåŒæ—¶ç”Ÿæˆ3ä¸ªé¡µé¢
    const maxConcurrent = 3;
    
    for (let i = 0; i < childPageIds.length && i < maxConcurrent; i++) {
        // ...
    }
}
```

**é€‰é¡¹Cï¼šå®šæœŸæ¸…ç†èŠå¤©è®°å½•**
```javascript
// åœ¨é€‚å½“çš„æ—¶å€™æ¸…ç†
async function cleanupChatHistory() {
    // åªä¿ç•™æœ€è¿‘100æ¡æ¶ˆæ¯
    if (chat.length > 100) {
        chat.splice(0, chat.length - 100);
        await saveChat();
    }
}
```

### 2. UIæ€§èƒ½è€ƒè™‘

**ç°è±¡ï¼š**
- å¹¶å‘ç”Ÿæˆå¤šä¸ªé¡µé¢æ—¶ï¼ŒUIä¼šé¢‘ç¹åˆ·æ–°
- å¯èƒ½ä¼šæœ‰è½»å¾®å¡é¡¿

**å»ºè®®ï¼š**
- é™åˆ¶å¹¶å‘æ•°é‡ä¸º3-5ä¸ª
- é¿å…åŒæ—¶ç”Ÿæˆå¤ªå¤šé¡µé¢

### 3. é”™è¯¯å¤„ç†

**ç°è±¡ï¼š**
- å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œé”™è¯¯æ¶ˆæ¯ä¹Ÿä¼šä¿å­˜åˆ°èŠå¤©è®°å½•

**å»ºè®®ï¼š**
- åœ¨ `executeGeneration` æ–¹æ³•ä¸­æ·»åŠ é”™è¯¯å¤„ç†
- å¤±è´¥æ—¶åˆ é™¤é”™è¯¯æ¶ˆæ¯

---

## ğŸ”„ å¦‚ä½•å›æ»šåˆ°V1

å¦‚æœä½ å‘ç°V2ä¸é€‚åˆä½ çš„ä½¿ç”¨åœºæ™¯ï¼Œå¯ä»¥è½»æ¾å›æ»šï¼š

### æ­¥éª¤1ï¼šä¿®æ”¹ pregeneration.js

```diff
- import { getConcurrentGeneratorV2 } from './concurrent-generator-v2.js';
+ import { getConcurrentGenerator } from './concurrent-generator.js';

- const generator = getConcurrentGeneratorV2();
+ const generator = getConcurrentGenerator();
```

### æ­¥éª¤2ï¼šé‡å¯SillyTavern

åˆ·æ–°é¡µé¢æˆ–é‡å¯SillyTavernå³å¯ã€‚

---

## ğŸ“ æµ‹è¯•æ¸…å•

åœ¨æ­£å¼ä½¿ç”¨å‰ï¼Œå»ºè®®è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•

- [ ] é¢„ç”Ÿæˆç³»ç»Ÿèƒ½å¦æ­£å¸¸å¯åŠ¨
- [ ] é¡µé¢å˜æ›´æ—¶èƒ½å¦è§¦å‘é¢„ç”Ÿæˆ
- [ ] ç”Ÿæˆçš„å†…å®¹æ˜¯å¦æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢
- [ ] ç”Ÿæˆçš„å†…å®¹æ˜¯å¦ä¿å­˜åˆ°èŠå¤©è®°å½•
- [ ] å‘é€æŒ‰é’®çŠ¶æ€æ˜¯å¦æ­£å¸¸

### âœ… å¹¶å‘æµ‹è¯•

- [ ] èƒ½å¦åŒæ—¶ç”Ÿæˆå¤šä¸ªé¡µé¢
- [ ] UIæ˜¯å¦æµç•…
- [ ] æ‰€æœ‰é¡µé¢æ˜¯å¦éƒ½æ­£ç¡®ç”Ÿæˆ

### âœ… é”™è¯¯å¤„ç†æµ‹è¯•

- [ ] ç”Ÿæˆå¤±è´¥æ—¶æ˜¯å¦æ­£ç¡®å¤„ç†
- [ ] é”™è¯¯æ¶ˆæ¯æ˜¯å¦åˆç†
- [ ] ç³»ç»Ÿèƒ½å¦ç»§ç»­è¿è¡Œ

### âœ… æ€§èƒ½æµ‹è¯•

- [ ] èŠå¤©å†å²æ–‡ä»¶å¤§å°æ˜¯å¦å¯æ¥å—
- [ ] UIåˆ·æ–°æ˜¯å¦æµç•…
- [ ] å†…å­˜å ç”¨æ˜¯å¦æ­£å¸¸

---

## ğŸ‰ æ€»ç»“

### å·²å®ç°çš„ç›®æ ‡

âœ… **ä¿å­˜åˆ°èŠå¤©è®°å½•**
- æ‰€æœ‰ç”Ÿæˆçš„å†…å®¹éƒ½ä¼šä¿å­˜
- åˆ·æ–°é¡µé¢åä¸ä¼šä¸¢å¤±

âœ… **æ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢**
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ç”Ÿæˆè¿‡ç¨‹
- å¯ä»¥å›æº¯æŸ¥çœ‹å†å²å†…å®¹

âœ… **ä¸è§¦å‘å‘é€æŒ‰é’®çŠ¶æ€**
- å‘é€æŒ‰é’®ä¸ä¼šå˜ä¸º"æ­£åœ¨è¯·æ±‚"çŠ¶æ€
- ä¸ä¼šå¹²æ‰°ç”¨æˆ·çš„æ­£å¸¸æ“ä½œ

### ä»£ç æ”¹åŠ¨é‡

- **æ–°å¢æ–‡ä»¶**ï¼š5ä¸ª
- **ä¿®æ”¹æ–‡ä»¶**ï¼š1ä¸ªï¼ˆpregeneration.jsï¼‰
- **ä¿®æ”¹è¡Œæ•°**ï¼š3è¡Œ
- **APIå…¼å®¹æ€§**ï¼š100%å…¼å®¹

### ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•V2åŠŸèƒ½**
   - è¿è¡Œæµ‹è¯•æ–‡ä»¶ `test-concurrent-v2.js`
   - åœ¨å®é™…æ¸¸æˆä¸­æµ‹è¯•é¢„ç”Ÿæˆ

2. **æ ¹æ®éœ€è¦è°ƒæ•´**
   - é™åˆ¶é¢„ç”Ÿæˆå±‚æ•°
   - é™åˆ¶å¹¶å‘æ•°é‡
   - æ·»åŠ é”™è¯¯å¤„ç†

3. **ç›‘æ§æ€§èƒ½**
   - è§‚å¯ŸèŠå¤©å†å²æ–‡ä»¶å¤§å°
   - è§‚å¯ŸUIæ€§èƒ½
   - æ ¹æ®éœ€è¦ä¼˜åŒ–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [concurrent-generator-v2.js](./concurrent-generator-v2.js) - V2å®ç°
- [CONCURRENT_GENERATOR_COMPARISON.md](./CONCURRENT_GENERATOR_COMPARISON.md) - V1 vs V2 å¯¹æ¯”
- [MIGRATION_TO_V2.md](./MIGRATION_TO_V2.md) - è¯¦ç»†è¿ç§»æŒ‡å—
- [test-concurrent-v2.js](./test-concurrent-v2.js) - V2æµ‹è¯•æ–‡ä»¶

---

## ğŸ’¬ åé¦ˆ

å¦‚æœä½ åœ¨ä½¿ç”¨V2æ—¶é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œæˆ–è€…æœ‰ä»»ä½•å»ºè®®ï¼Œè¯·éšæ—¶åé¦ˆï¼

**å¸¸è§é—®é¢˜ï¼š**

1. **Q: èŠå¤©å†å²å¤ªå¤šæ€ä¹ˆåŠï¼Ÿ**
   A: é™åˆ¶é¢„ç”Ÿæˆå±‚æ•°ï¼Œæˆ–å®šæœŸæ¸…ç†èŠå¤©è®°å½•

2. **Q: UIåˆ·æ–°å¤ªé¢‘ç¹æ€ä¹ˆåŠï¼Ÿ**
   A: é™åˆ¶å¹¶å‘æ•°é‡ä¸º3-5ä¸ª

3. **Q: æƒ³å›åˆ°V1æ€ä¹ˆåŠï¼Ÿ**
   A: ä¿®æ”¹ `pregeneration.js` çš„å¯¼å…¥å³å¯

4. **Q: V1å’ŒV2å¯ä»¥å…±å­˜å—ï¼Ÿ**
   A: å¯ä»¥ï¼Œä¸¤ä¸ªæ–‡ä»¶éƒ½ä¿ç•™ï¼Œæ ¹æ®éœ€è¦åˆ‡æ¢å¯¼å…¥

5. **Q: å¦‚ä½•æµ‹è¯•V2ï¼Ÿ**
   A: è¿è¡Œ `test-concurrent-v2.js` ä¸­çš„æµ‹è¯•å‡½æ•°

